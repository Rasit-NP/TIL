# Static & Media

# Static Files
### Static Files
- 서버 측에서 변경되지 않고 고정적으로 제공되는 파일
- CSS 파일, JavaScript 파일, 이미지 파일, 폰트 파일

## 웹 서버와 정적 파일
### 웹 서버의 정적 파일 처리 과정
1. 사용자가 브라우저에 URL 주소를 입력하며 이미지를 요청
2. 웹 서버는 URL을 확인하고, 서버에 미리 약속된 폴더에서 이미지 파일을 찾음
3. 웹 서버는 찾은 이미지 파일을 HTTP 응답에 담아 사용자에게 전송
4. 브라우저는 응답 받은 이미지 파일을 화면에 보여줌

### Static Files 경로의 종류
1. 기본 경로
2. 추가 경로

## Static Files 기본 경로
### 정적 파일의 기본 경로
> `app폴더/static/`

### 기본 경로 CSS 스타일 제공
- `apps/static/stylesheets/` 경로에 CSS 파일 배치
- 페이지에서 CSS 파일 불러오기
    ```HTML
    <!-- articles/index.html -->
    
    {% load static %}
    
    <link rel="stylesheet" href="{% static 'stylesheets/style.css' %}">
    ```
    - static files 경로는 DTL의 static tag를 사용해야 함
    - built-in tag가 아니기 때문에 load tag를 사용해 import 후 가능

### `{% load %}`
- 특정 라이브러리의 태그와 필터를 현재 템플릿에서 사용할 수 있도록 불러옴
- `{% load static %}`은 `{% static %}` 태그를 사용하기 위해
, Django 템플릿 시스템에 "static 태그를 사용하겠다"고 알려주는 선언문
- load 태그는 템플릿 파일의 가장 상단에 한 번만 작성하면 됨

### `{% static "경로" %}`
- settings.py 파일의 STATIC_URL 값을 기준으로, 해당 정적 파일의 전체 URL 경로를 계산하여 생성
- `STATIC = 'static/'`이고, CSS 파일이 `static/css/style.css`에 위치한다면, 경로가 필요한 위치에 `{% static 'css/style.css' %}`로 작성

### STATIC_URL
- 정적 파일의 우베 주소
- 웹 페이지에서 정적 파일에 접근할 때 사용할 URL의 시작 부분을 지정하는 설정
- 서버 컴퓨터에 저장된 실제 파일 경로가 아닌, 오직 브라우저에서만 사용되는 주소

### 기본 경로 이미지 파일 제공
- `apps/static/images/` 경로에 이미지 파일 배치
- DTL의 `static tag`를 사용해 이미지 경로 작성
    ```HTML
    <!-- articles/index.html -->
    <img src="{% static 'images/sample-1.png' %}" alt="sample image">
    ```

### 정적 파일의 URL
> URL + STATIC_URL + 정적 파일 경로
- `http://127.0.0.1:8000/static/images/sample-1.png`

## Static Files 추가 경로
### Static Files
- 기본 경로 외에 추가적으로 탐색할 경로의 목록을 지정하는 리스트
- Django는 이 목록에 있는 모든 폴더를 방문하여 필요한 정적 파일을 찾음

### STATICFILES_DIRS 설정
```python
# settings.py

STATICFILES_DIRS = [
    BASE_DIR / 'static',
]
```
- Django는 기본 경로인 각 앱의 `static/` 폴더를 모두 확인한 후
, 프로젝트의 최상위 폴더에 있는 `static/` 폴더도 추가로 탐색하게 됨

### 추가 경로 이미지 파일 제공
```HTML
<!-- apps/index.html -->

<img src="{% static 'sample-2.png' %}" alt="sample image">
```

### 정적 파일의 핵심 원리
- 주소(URL)이 있어야 찾아갈 수 있음
- 컴퓨터에 파일이 존재하는 것 만으로는 웹 페이지에 보일 수 없음
- 브라우저에서 이 파일을 찾아올 수 있도록 반드시 웹 주소를 달아줘야 함

# Media Files
### Media Files
- 사용자가 웹 사이트를 통해 직접 업로드하는 파일
- Static Files가 개발자가 미리 준비해 둔 고정된 파일이라면, Media Files는 사이트 운용 중 사용자에 의해 생성되고 변경되는 동적인 파일

## 이미지 업로드
### `ImageField()`
```python
# models.py

class Article(models.Model):
    image = models.ImageField(upload_to='images/')
```
- 이미지 파일을 업로드하기 위해 사용되는 Django 모델 필드
- 데이터베이스 저장 방식
    - 이미지 파일 자체가 데이터베이스에 저장되는 것이 아님
    - 데이터베이스에는 `upload_to` 경로를 기준으로 한 이미지 파일의 경로만 저장되고
    , 실제 파일은 서버의 특정 폴더(`MEDIA_ROOT`)에 저장

### 미디어 파일을 제공하기 전 준비사항
1. `settings.py`에 `MEDIA_ROOT`, `MEDIA_URL` 설정
2. 작성한 `MEDIA_ROOT`와 `MEDIA_URL`에 대한 URL 지정

### MEDIA_ROOT
```python
MEDIA_ROOT = BASE_DIR / 'media'
```
- 미디어 파일의 실제 저장 주소
- 사용자가 업로드한 미디어 파일들이 서버 컴퓨터 어디에 저장될 지를 지정하는 절대 경로
- 서버 내부에서만 사용하는 물리적인 폴더 주소로, Django는 파일을 저장하거나 읽어올 때 이 경로를 사용

### MEDIA_URL
```python
MEDIA_URL = 'media/'
```
- 미디어 파일의 '웹 주소' 별명
- `MEDIA_ROOT`에 저장된 파일들을 웹 페이지에서 접근할 때 사용할 URL의 시작 부분을 지정
- STATIC_URL과 동일한 역할로, 실제 저장 위치를 숨기고 웹에서 사용할 공개 주소 별명을 만드는 것

### MEDIA_ROOT와 MEDIA_URL 설정
```python
# settings.py

MEDIA_ROOT = BASE_DIR / 'media'
MEDIA_URL = 'media'
```
```python
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path('admin/', admin.site.urls),
    path('apps/', include('apps.urls')),
] + static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
```

### 이미지 업로드 구현
- 모델 클래스에 image 필드 작성
    ```python
    # apps/models.py

    class Article(models.Model):
            title = models.CharField(max_length=10)
            content = models.TextField()
            image = models.ImageField(upload_to='images/', blank=True)
            created_at = models.DateTimeField(auto_now_add=True)
            updated_at = models.DateTimeField(auto_now=True)
    ```
- migrations 진행 시 에러 발생
- Pillow 설치 후 migrations 재진행
    ```bash
    $ pip install pillow
    $ python manage.py makemigrations
    $ python manage.py migrate
    ```
- form 요소의 enctype 속성 추가
    ```HTML
    <!-- apps/create.html -->
    <h1>CREATE</h1>
    <form action="{% url 'apps:create' %}" method='POST' enctype="multipart/form-data">
        {% csrf_token %}
        {{ form }}
        <input type="submit">
    </form>
    ```
- ModelForm의 두 번째 인자로 요청 받은 파일 데이터 작성
    ```python
    # articles/views.py

    def create(request):
        if request.method == 'POST':
            form = ArticleForm(request.POST, request.FILES)
            ...
    ```
- 이미지 업로드 후 DB 확인
    - 이미지 파일 자체가 데이터베이스에 저장되는 것이 아닌
    , `upload_to` 경로를 기준으로 한 이미지 파일의 경로만 저장

## 업로드 이미지 제공
### 업로드한 이미지 제공하기
- ImageField의 `.url` 속성
    ```HTML
    <!-- articles/detail.html -->

    {% if article.image %}
        <img src="{{ article.image.url }}" alt="image">
    {% endif %}
    ```
    - 업로드 파일의 웹 주소
    - ImageField나 FileField에 저장된 파일 객체에서 `.url` 속성을 사용하면
    , 해당 파일을 웹에서 접근할 수 있는 전체 URL 주소를 얻을 수 있음

## 업로드 이미지 수정
### 업로드 이미지 수정
- 수정 페이지 form 요소에 enctype 속성 추가
    ```HTML
    <!-- apps/update.html -->

    <h1>UPDATE</h1>
    <form action="{% url 'apps:update' %}" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form }}
        <input type="submit">
    </form>
    ```
- update view 함수에서 업로드 파일에 대한 추가 코드 작성
    ```python
    # articles/views.py

    def update(request, pk):
            article = Article.objects.get(pk=pk)
            if request.method == 'POST':
                    form = ArticleForm(request.POST, request.FILES, instance=article)
            ...
    ```