# 회원 가입
### 회원 가입
- User 객체를 Create 하는 과정
- 사용자로부터 아이디, 비밀번호 등의 정보를 입력 받아, DB에 새로운 User 객체를 생성하고 저장

### `UserCreationForm()`
- 회원가입 시 사용자 입력 데이터를 받는 built-in ModelForm
- ModelForm이기 때문에, 유효성 검사를 통과한 데이터로 새로운 User 객체를 생성하고 데이터베이스에 저장하는 역할을 수행

### 커스텀 유저 모델을 사용하기 위한 `Form` 재작성
```python
# accounts/forms.py

from django.contrib.auth import get_user_model
from django.contrib.auth.forms import UserCreationForm

class CustomUserCreationForm(UserCreationForm):
    class Meta(UserCreationForm.Meta):
        model = get_user_model()
```

### `get_user_model()`
- 현재 프로젝트에서 활성화된 사용자 모델(active user model)을 반환하는 함수
- 프로젝트 설정(AUTH_USER_MODEL)에 따라 기본 User model일 수도, 커스텀 User model일 수도 있기 때문에 올바른 모델을 동적으로 가져오기 위해 사용
- User model이 바뀌어도 코드를 수정할 필요가 없어 재사용성과 유연성이 높아짐

### 회원 가입 함수 작성
```python
# accounts/views.py

from django.contrib.auth.forms import CustomUserCreationForm

def signup(request):
    if request.method == 'POST':
        form = CustomUserCreationForm(request.POST)
        if form.is_valid():
            form.save()
            return redirect('articles:index')
    else:
        form = CustomUserCreationForm()
    context = {
        'form': form,
    }
    return render(request, 'accounts/signup.html', context)
```

# 회원 탈퇴
### 회원 탈퇴
- User 객체를 Delete하는 과정
- `request.user.delete()`를 활용해서 유저 객체 전체 삭제를 진행

### 회원 탈퇴 함수 작성
```python
# accounts/views.py

def delete(request):
    reqeust.user.delete()
    return redirect('articles:index')
```

# 인증된 사용자에 대한 접근 제한
## `is_authenticated` 속성
- 사용자가 인증되었는지 여부를 알 수 있는 User model의 읽기 전용 속성
- 인증 사용자에 대해서는 항상 `True`, 비인증 사용자에 대해서는 항상 `False`
- 사용되는 경우
    - 사용자의 로그인 상태에 따라 다른 메뉴를 보여줄 때
    - view 함수 내에서 특정 기능을 로그인한 사용자에게만 허용하고 싶을 때

### `is_authenticated` 적용
1. 로그인과 비로그인 상태에서 화면에 출력되는 링크를 다르게 설정
    ```html
    <!-- articles/index.html -->

    {% if request.user.is_authenticated %}
      ...
    {% else %}
      ...
    {% endif %}
    ```
2. 인증된 사용자라면 로그인/회원가입 로직을 수행할 수 없도록 하기
    ```python
    # accounts/views.py

    def login(request):
        if request.user.is_authenticated:
            return redirect('articles:index')

    def signup(request):
        if request.user.is_authenticated:
            return redirect('articles:index')
    ```

## `login_required` 데코레이터
- 인증된 사용자에 대해서만 view 함수를 실행시키는 데코레이터
- 비인증 사용자의 경우 `/accounts/login/` 주소로 redirect 시킴

### `login_required` 적용
1. 인증된 사용자만 게시글을 작성/수정/삭제할 수 있도록 수정
    ```python
    # articles/views.py
    from django.contrib.auth.decorators import login_required

    @login_required
    def create(request):
        pass

    @login_required
    def delete(request, article_pk):
        pass
    
    @login_required
    def update(request, article_pk):
        pass
    ```
2. 인증된 사용자만 로그아웃/탈퇴/수정/비밀번호 변경을 할 수 있도록 수정
    ```python
    # accounts/views.py

    from django.contrib.auth.decorators import login_required

    @login_required
    def logout(request):
        pass

    @login_required
    def delete(request):
        pass
    
    @login_required
    def update(request):
        pass
    
    @login_required
    def change_password(request):
        pass
    ```

# 회원 정보 수정
### 회원 정보 수정
- User 객체를 Update하는 과정
- 수정할 대상 User 객체를 가져오고, 입력받은 새로운 정보로 기존 내용을 갱신

### `UserChangeForm()`
- 회원 정보 수정 시 사용자 입력 데이터를 받는 built-in ModelForm
- ModelForm이기 때문에, 유효성 검사를 통과한 데이터로 기존 User 객체의 내용을 갱신하고 저장

### CustomUserChangeForm 출력 필드 재정의
```python
# accounts/forms.py

class CustomUserChangeForm(UserChangeForm):
    class Meta(UserChangeForm.Meta):
        model = get_user_model()
        fields = ('first_name', 'last_name', 'email',)
```

### 회원 정보 수정 함수 작성
```python
# accounts/views.py

from .forms import CustomUserChangeForm

def update(request):
    if request.method == 'POST':
        form = CustomUserChangeForm(request.POST, instance=request.user)
        if form.is_valid():
            form.save()
            return redirect('articles:index')
    else:
        form = CustomUserChangeForm(instance=request.user)
    context = {
        'form': form,
    }
    return render(request, 'accounts/update.html', context)
```

# 비밀번호 변경
## 비밀번호 변경
### 비밀번호 변경
- 인증된 사용자의 Session 데이터를 Update하는 과정
- 기존 비밀번호를 통해 사용자를 인증하고, 새로운 비밀번호를 암호화하여 갱신

### `passwordChangeForm()`
- 비밀번호 변경 시 사용자 입력 데이터를 받는 built-in Form
- 일반 Form이며, 유효성 검사를 통과한 데이터로 사용자의 비밀번호를 안전하게 암호화하여 갱신하는 역할을 수행

### 비밀번호 변경 페이지 작성
```python
# accounts/views.py

from django.contrib.auth.forms import PasswordChangeForm

def password(request):
    if request.method == 'POST':
        form = PasswordChangeForm(request.user, request.POST)
        if form.is_valid():
            user = form.save()
            return redirect('articles:index')
    else:
        form = PasswordChangeForm(request.user)
    context = {
        'form': form,
    }
    return render(request, 'accounts/password.html', context)
```
- Django는 비밀번호 변경 페이지를 회원정보 수정 form 하단에서 별도 주소로 안내
- 비밀번호 변경에 사용할 데이터를 입력받는 `PasswordChangeForm` 사용

## 세션 무효화 방지
### 암호 변경 시 세션 무효화
- 비밀번호가 변경되면 기존 세션과의 회원 인증 정보가 일치하지 않게 되어 버려 로그인 상태가 유지되지 못하고 로그아웃 처리됨
- 비밀번호가 변경되면서 기존 세션과의 회원 인증 정보가 일치하지 않기 때문

### `update_session_auth_hash`
```python
# accounts/views.py

from django.contrib.auth import update_session_auth_hash

def password(request):
    if request.method == 'POST':
        form = PasswordChangeForm(request.user, request.POST)
        if form.is_valid():
            user = form.save()
            update_session_auth_hash(request, user)
            return redirect('articles:index')
    else:
        form = PasswordChangeForm(request.user)
    context = {
        'form': form,
    }
    return render(request, 'accounts/password.html', context)
```