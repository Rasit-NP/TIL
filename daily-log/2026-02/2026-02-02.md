# 2026-02-02

## ğŸ§  ì˜¤ëŠ˜ ë°°ìš´ ê²ƒ
- Docker Compose í™˜ê²½ì—ì„œì˜ Nginx 502 ì¥ì•  ë¶„ì„

## ì¥ì•  í˜„ìƒ
- ì„œë¹„ìŠ¤ ìš´ì˜ ì¤‘ í”„ë¡ íŠ¸ì—”ë“œì™€ ë°±ì—”ë“œ ê°„ í†µì‹  ë‹¨ì ˆë¡œ ì¸í•´ ì™¸ë¶€ ì ‘ì† ì‹œ `502 Bad Gateway` ì—ëŸ¬ê°€ ì§€ì†ì ìœ¼ë¡œ ë°œìƒ
- **Nginx ë¡œê·¸**
    - `connect() failed (111: Connection refused)` ë©”ì‹œì§€ê°€ ë°˜ë³µë¨
    - ì—…ìŠ¤íŠ¸ë¦¼ ì„œë²„ì˜ IP ì£¼ì†Œê°€ í˜„ì¬ ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆì˜ ì‹¤ì œ IPì™€ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” í˜„ìƒ í™•ì¸
- **ë°±ì—”ë“œ ë¡œê·¸**
    - `java.net.UnknownHostException: db` ë°œìƒ
    - ì• í”Œë¦¬ì¼€ì´ì…˜ì´ DB ì„œë²„ì˜ í˜¸ìŠ¤íŠ¸ëª…ì„ í•´ì„í•˜ì§€ ëª»í•´ êµ¬ë™ ë‹¨ê³„ì—ì„œ ì¤‘ë‹¨ë¨

## ë°œìƒ ì›ì¸
### Nginxì˜ ì •ì  DNS í•´ì„
- NginxëŠ” êµ¬ë™ ì‹œ ì„¤ì • íŒŒì¼(`nginx.conf`)ì— ì •ì˜ëœ í˜¸ìŠ¤íŠ¸ëª…ì„ ë‹¨ í•œ ë²ˆë§Œ IPë¡œ ë³€í™˜í•˜ì—¬ ë©”ëª¨ë¦¬ì— ì €ì¥
- Docker í™˜ê²½ì—ì„œëŠ” ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ì‹œ IPê°€ ìœ ë™ì ìœ¼ë¡œ ë³€í•¨
- Nginxê°€ ê°±ì‹ ëœ IPë¥¼ ì¸ì§€í•˜ì§€ ëª»í•˜ê³  ì´ì „ IPë¡œ ì—°ê²°ì„ ì‹œë„í•˜ë©´ì„œ í†µì‹  ì¥ì•  ë°œìƒ

### Docker ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬ë¡œ ì¸í•œ í†µì‹  ë¶ˆê°€
- `docker-compose.yml` ì„¤ì • ë³€ê²½ ê³¼ì •ì—ì„œ ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆëŠ” ì‹ ê·œ ë„¤íŠ¸ì›Œí¬(`dev-net`)ì— í• ë‹¹ë˜ì—ˆìŒ
    - DB ì»¨í…Œì´ë„ˆëŠ” ê¸°ì¡´ ë„¤íŠ¸ì›Œí¬(`default`)ì— ì”ë¥˜
- ë™ì¼ í˜¸ìŠ¤íŠ¸ ë‚´ì— ì¡´ì¬í•˜ë”ë¼ë„ ë…¼ë¦¬ì  ë„¤íŠ¸ì›Œí¬ê°€ ë¶„ë¦¬ë˜ì–´ ë°±ì—”ë“œì—ì„œ DB í˜¸ìŠ¤íŠ¸ëª…ì„ ì°¾ì„ ìˆ˜ ì—†ëŠ” í˜„ìƒ ë°œìƒ

## í•´ê²° ë°©ë²•
### Nginx ë™ì  ë¦¬ì¡¸ë²„(Resolver) ì„¤ì •
```conf
events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # 1. HTTP(80) -> HTTPS ë¦¬ë‹¤ì´ë ‰íŠ¸
    server {
        listen 80;
        server_name my_domain;
        return 301 https://$host$request_uri;
    }

    # 2. HTTPS ì„œë²„ (ë‚´ë¶€ëŠ” ë¬´ì¡°ê±´ 443)
    server {
        listen 443 ssl;
        server_name my_domain;

        # ì¸ì¦ì„œ ê²½ë¡œ (Docker Volumeìœ¼ë¡œ ë§ˆìš´íŠ¸ ë  ì˜ˆì •)
        ssl_certificate /etc/letsencrypt/live/my_domain/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/my_domain/privkey.pem;

        location /uploads/ {
            alias /var/www/uploads/;
            access_log off;
        }

        # í”„ë¡ íŠ¸ì—”ë“œ ì—°ê²°
        location / {
            resolver 127.0.0.11 valid=30s;
            set $frontend_url http://frontend:80;
            proxy_pass $frontend_url;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ë°±ì—”ë“œ ì—°ê²°
        location /api/ {
            resolver 127.0.0.11 valid=30s;
            set $backend_url http://backend:8080;
            proxy_pass $backend_url;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
```
- Nginxê°€ ì‹¤í–‰ ì¤‘ì—ë„ ë„ë©”ì¸ ì£¼ì†Œë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ë‹¤ì‹œ í•´ì„í•˜ë„ë¡ ì„¤ì •
- `nginx.conf`ì— Docker ë‚´ë¶€ DNS ì„œë²„(`127.0.0.11`)ë¥¼ ëª…ì‹œí•˜ê³ , `proxy_pass`ì— ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤ì‹œê°„ IP ê°±ì‹ ì„ ë³´ì¥

### Docker ë„¤íŠ¸ì›Œí¬ í†µí•©
```yml
version: '3.8'
services:
  nginx:
    image: nginx:latest
    container_name: nginx-prod
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro  # ì„¤ì • íŒŒì¼
      - /etc/letsencrypt:/etc/letsencrypt:ro         # í˜¸ìŠ¤íŠ¸ ì¸ì¦ì„œ
      - ./BE/uploads:/var/www/uploads:ro
    depends_on:
      - frontend
      - backend
    networks:
      - prod-net
    restart: always

  db:
    image: mysql:8.4
    container_name: mysql-db
    networks:
      - prod-net
    env_file: .env
    environment:
      - MYSQL_DATABASE=wellie_database
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_USER=user
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - ./mysql_data:/var/lib/mysql
    restart: always

  backend:
    build:
        context: ./BE
        dockerfile: Dockerfile
    container_name: spring-backend
    volumes:
      - ./BE/uploads:/app/uploads
    networks:
      prod-net:
        aliases:
          - backend # NginxëŠ” ì´ ì´ë¦„ìœ¼ë¡œ ì°¾ìŒ
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - POLICY_USER_PASSWORD=${POLICY_USER_PASSWORD}
    expose:
      - "8080"
    depends_on:
      - db
    restart: always

  frontend:
    build:
      context: ./FE
      dockerfile: Dockerfile
    container_name: react-frontend
    networks:
      prod-net:
        aliases:
          - frontend # NginxëŠ” ì´ ì´ë¦„ìœ¼ë¡œ ì°¾ìŒ
    expose:
      - "80"
    depends_on:
      - backend
    restart: always

  ocr:
    build:
      context: ./OCR
      dockerfile: Dockerfile
    container_name: fastapi-ocr
    networks:
      - prod-net
    ports:
    - "8000:8000"
    depends_on:
      - db
      - backend
    restart: always
  
networks:
  prod-net:
    driver: bridge
```
```yml
version: '3.8'
services:
  nginx:
    image: nginx:latest
    container_name: nginx-dev
    ports:
      # ì™¸ë¶€ì—ì„œ 8443ìœ¼ë¡œ ë“¤ì–´ì˜¤ë©´ -> ë‚´ë¶€ì˜ 443(nginx.confì„¤ì •)ìœ¼ë¡œ í† ìŠ¤
      - "8443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - ./BE/uploads:/var/www/uploads:ro
    depends_on:
      - frontend
      - backend
    networks:
      - dev-net
    restart: always

  db:
    image: mysql:8.4
    container_name: mysql-db-dev
    networks:
      - dev-net
    command: --mysql-native-password=ON --authentication-policy=mysql_native_password
    env_file:
      - .env
    environment:
      - MYSQL_DATABASE=dev_database
      - MYSQL_ROOT_PASSWORD=${DEV_ROOT_PASSWORD}
      - MYSQL_ROOT_HOST=%
    ports:
      - "3307:3306"
    volumes:
      - ./mysql_dev_data:/var/lib/mysql
    restart: always

  backend:
    build:
        context: ./BE
        dockerfile: Dockerfile
    container_name: spring-backend-dev
    networks:
      dev-net:
        aliases:
          - backend # NginxëŠ” ì´ ì´ë¦„ìœ¼ë¡œ ì°¾ìŒ
    volumes:
      - ./BE/uploads:/app/uploads
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - DB_ROOT_PASSWORD=${DEV_ROOT_PASSWORD}
      - POLICY_USER_PASSWORD=${POLICY_USER_PASSWORD}
      - OCR_URL=${OCR_URL}
    expose:
      - "8080"
    depends_on:
      - db
    restart: always

  frontend:
    build:
      context: ./FE
      dockerfile: Dockerfile
    container_name: react-frontend-dev
    networks:
      dev-net:
        aliases:
          - frontend # NginxëŠ” ì´ ì´ë¦„ìœ¼ë¡œ ì°¾ìŒ
    expose:
      - "80"
    depends_on:
      - backend
    restart: always

  ocr:
    build:
      context: ./OCR
      dockerfile: Dockerfile
    container_name: fastapi-ocr-dev
    networks:
      - dev-net
    ports:
    - "8001:8000"
    depends_on:
      - db
      - backend
    restart: always
  
networks:
  dev-net:
    driver: bridge
```
- í”„ë¡œì íŠ¸ ë‚´ ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ë™ì¼í•œ í”„ë¡œì íŠ¸ ë„¤íŠ¸ì›Œí¬ë¥¼ ê³µìœ í•˜ë„ë¡ ì„¤ì •ì„ í†µì¼
- ê° ì„œë¹„ìŠ¤ì— ëª…ì‹œì ì¸ `networks` ì„¤ì •ì„ ì¶”ê°€í•˜ê³ , í™˜ê²½ì— ê´€ê³„ ì—†ì´ ë™ì¼í•œ ë³„ì¹­(`backend`, `frontend`)ì„ ì‚¬ìš©í•˜ì—¬ ì„¤ì • íŒŒì¼ì˜ ì´ì‹ì„±ì„ ë†’ì„

### ì»¨í…Œì´ë„ˆ ë° ë„¤íŠ¸ì›Œí¬ í™˜ê²½ ê°•ì œ ì´ˆê¸°í™”
- ë„¤íŠ¸ì›Œí¬ ì„¤ì • ë³€ê²½ ì‚¬í•­ì„ ëª¨ë“  ì»¨í…Œì´ë„ˆì— ì¦‰ê° ë°˜ì˜í•˜ê¸° ìœ„í•´ í™˜ê²½ì„ ì¬êµ¬ì¶•
- `docker compose down` ë° `docker network prune`ì„ í†µí•´ ìœ íš¨í•˜ì§€ ì•Šì€ ë„¤íŠ¸ì›Œí¬ ì°Œêº¼ê¸°ë¥¼ ì‚­ì œ
- `--force-recreate` ì˜µì…˜ì„ ì‚¬ìš©í•´ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ì¬ê°€ë™

## ê²°ë¡  ë° í–¥í›„ ë°©ì§€ ëŒ€ì±…
- Docker ê¸°ë°˜ ì¸í”„ë¼ì—ì„œ í˜¸ìŠ¤íŠ¸ëª… ê¸°ë°˜ í†µì‹ ì„ ìˆ˜í–‰í•  ê²½ìš°, ì„œë¹„ìŠ¤ ê°„ ë„¤íŠ¸ì›Œí¬ ì†Œì† ì—¬ë¶€ì™€ DNS ìºì‹± ì£¼ê¸°ë¥¼ ë°˜ë“œì‹œ ê³ ë ¤í•´ì•¼ í•¨
- ë³µìˆ˜ì˜ Compose íŒŒì¼ì„ ìš´ì˜í•  ê²½ìš°, ë„¤íŠ¸ì›Œí¬ ê³µìœ  ì •ì±…(`external network` ë“±)ì„ ì‚¬ì „ì— ì •ì˜