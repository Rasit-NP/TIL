# 2026-01-22

## 🧠 오늘 배운 것
- 단일 EC2에서 Docker Compose를 이용한 개발/운영 환경 분리 배포

### 개요
- 목표
    - 1대의 EC2 서버 자원을 효율적으로 사용하여, 서비스 중단 없이 `develop` 브랜치의 기능을 테스트하고, `main` 브랜치를 안정적으로 배포

### 핵심 전략
1. 서버 내 디렉토리 격리
    - 소스 코드 간섭 및 빌드 충돌을 방지하기 위해 서버 내 경로를 완전히 분리
    - `~/app_prod`
        - `main` 브랜치 소스 및 운영용 컨테이너 관리
    - `~/app_dev`
        - `develop` 브랜치 소스 및 개발용 컨테이너 관리
2. 네트워크 및 포트 설계
    |service    |Prod   |Dev    |
    |-----------|-------|-------|
    |Frontend   |80     |3000   |
    |Backend    |8080   |8081   |
    |Database   |3306   |3307   |
    - 동일 IP 주소를 사용하므로 포트 번호를 중복되지 않게 설계

### 주요 구현 내용
- Docker Compose 분리
    - `container_name`을 고유하게 지정하여 단일 도커 엔진 내에서 이름 충돌을 방지하는 것이 핵심
    - `docker-compose.yml`(Prod)
        - `container_name: app-backend-prod`
    - `docker-compose.develop.yml`(Dev)
        - `container_name: app-backend-dev`
- Jenkins CI/CD 파이프라인
    - 브랜치 별로 배포 위치와 실행 명령어를 다르게 분기 처리
    ```Groovy
    stage('Dev: Deploy'){
        when { branch 'develop' }
        steps {
            sshagent(credentials: ["ssh-key"]){
                sh """
                    ssh -o StrictHostKeyChecking=no ubuntu@IP "
                    cd ~/app_dev && 
                    git pull origin develop && 
                    sudo docker compose -f docker-compose.develop.yml up -d --build"
                """
            }
        }
    }
    ```

### 트러블슈팅 및 주의사항
1. 컨테이너 이름 충돌
    - 동일한 `container_name`을 사용하면 `docker compose up` 시 기존 운영 중인 컨테이너가 삭제되거나 에러가 발생
    - 반드시 접미사(`-dev`, `-prod`)를 붙여야 함
2. Docker Compose 명령어 순서
    - `-f` 옵션은 반드시 명령어(`up`, `down`) 앞에 위치해야 함
    - `sudo docker compose -f [파일명] up -d`
3. 브랜치 체크아웃
    - 서버 내 각 폴더가 처음부터 올바른 브랜치(`main` 또는 `develop`)를 추적하도록 `git checkout -t origin/[브랜치명]` 작업을 선행해야 함