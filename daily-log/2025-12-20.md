# 2025-12-20

## ğŸ§  ì˜¤ëŠ˜ ë°°ìš´ ê²ƒ
- Discord ì†Œì…œ ë¡œê·¸ì¸

### ê°œìš”
- Discord ì†Œì…œ ë¡œê·¸ì¸ì€ **OAuth 2.0 Authorization Code Grant ë°©ì‹ì„ ì‚¬ìš©
- ì‚¬ìš©ìëŠ” Discord ê³„ì •ìœ¼ë¡œ ì¸ì¦ì„ ìˆ˜í–‰í•˜ê³ , ì„œë²„ëŠ” Discordë¡œë¶€í„° ë°œê¸‰ë°›ì€ í† í°ì„ í†µí•´ ì‚¬ìš©ì ì •ë³´ë¥¼ í™•ì¸í•œ ë’¤, ìì²´ ë¡œê·¸ì¸(JWT)ì„ ì²˜ë¦¬

### ì „ì²´ ì¸ì¦ íë¦„
1. ë¡œê·¸ì¸ ìš”ì²­
    - ì‚¬ìš©ìê°€ "Discord ë¡œê·¸ì¸" ë²„íŠ¼ í´ë¦­
    - í”„ë¡ íŠ¸ì—”ë“œëŠ” Discord OAuth ì¸ì¦ URLë¡œ ì´ë™
2. Discord ì¸ì¦
    - ì‚¬ìš©ìëŠ” Discord ë¡œê·¸ì¸ ë° ê¶Œí•œ ë™ì˜
    - DiscordëŠ” ì¸ì¦ ì„±ê³µ ì‹œ `authorization code`ë¥¼ í¬í•¨í•´ Redirect URIë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
3. Authorization Code ì „ë‹¬
    - í”„ë¡ íŠ¸ì—”ë“œëŠ” Redirect URIì—ì„œ `code`ë¥¼ ì¶”ì¶œ
    - í•´ë‹¹ `code`ë¥¼ ë°±ì—”ë“œë¡œ POST ìš”ì²­ìœ¼ë¡œ ì „ë‹¬
4. Access Token êµí™˜
    - ë°±ì—”ë“œëŠ” Discord OAuth Token APIì— `code`ë¥¼ ì „ë‹¬
    - Discordë¡œë¶€í„° `access_token` ìˆ˜ì‹ 
5. ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
    - `access_token`ì„ ì‚¬ìš©í•´ Discord `/users/@me` API í˜¸ì¶œ
    - Discord ì‚¬ìš©ì ID, username, email íšë“
6. ì„œë²„ ì‚¬ìš©ì ì²˜ë¦¬
    - ì´ë©”ì¼ ê¸°ì¤€ìœ¼ë¡œ ê¸°ì¡´ ì‚¬ìš©ì ì¡°íšŒ
    - ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ì‹ ê·œ ì‚¬ìš©ì ìƒì„±
    - Discord IDë¥¼ ê³„ì •ì— ì—°ê²°
7. JWT ë°œê¸‰
    - ìì²´ ì¸ì¦ ì²´ê³„(Simple JWT)ë¡œ access / refresh í† í° ë°œê¸‰
    - ì´í›„ ì„œë¹„ìŠ¤ëŠ” JWT ê¸°ë°˜ ì¸ì¦ ì‚¬ìš©

### ì‹¤ì œ êµ¬í˜„ ì˜ˆì‹œ
1. êµ¬ì¡° ìš”ì•½
    - ì¸ì¦ ë°©ì‹
        - OAuth 2.0 Authorization Code Grant
    - ì„œë²„ ì—­í• 
        - Discordì™€ ì§ì ‘ í†µì‹ 
        - ì‚¬ìš©ì ì •ë³´ ê²€ì¦
        - JWT ë°œê¸‰
    - í”„ë¡ íŠ¸ ì—­í• 
        - Discord ì¸ì¦ í˜ì´ì§€ë¡œ ì´ë™
        - Redirect URIì—ì„œ `code` ìˆ˜ì‹ 
        - `code`ë¥¼ ë°±ì—”ë“œì— POST ì „ë‹¬
2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    ```
    DISCORD_CLIENT_ID=xxxxxxxxxxxxxxxx
    DISCORD_CLIENT_SECRET=xxxxxxxxxxxxxxxx
    DISCORD_REDIRECT_URI_FOR_LOGIN=http://localhost:8000/api/auth/discord/login/callback/
    ```
    - Redirect URIëŠ” Discord Developer Portalì— ë“±ë¡ëœ ê°’ê³¼ **ì™„ì „íˆ ë™ì¼**í•´ì•¼ í•¨
3. Discord ë¡œê·¸ì¸ URL ìƒì„±
    ```https://discord.com/oauth2/authorize
    ?client_id=CLIENT_ID
    &redirect_uri=REDIRECT_URI
    &response_type=code
    &scope=identify%20email
    ```
    - ì´ URLë¡œ ì´ë™í•˜ë©´
        1. Discord ë¡œê·¸ì¸
        2. ê¶Œí•œ ë™ì˜
        3. Redirect URIë¡œ `?code=xxxx`ë¥¼ í¬í•¨í•˜ì—¬ ì´ë™
4. Django URL ì„¤ì •
    ```python
    # urls.py
    from django.urls import path
    from .views import DiscordLoginCallbackView

    urlpatterns = [
        path("api/auth/discord/login/callback/", DiscordLoginCallbackView.as_view()),
    ]
    ```
5. Discord ë¡œê·¸ì¸ Callback View
    ```python
    # views.py
    import os
    import requests
    from django.contrib.auth import get_user_model
    from rest_framework.views import APIView
    from rest_framework.response import Response
    from rest_framework import status
    from rest_framework_simplejwt.tokens import RefreshToken

    User = get_user_model()

    class DiscordLoginCallbackView(APIView):
        """
        Discord OAuth ë¡œê·¸ì¸ Callback

        ì²˜ë¦¬ ìˆœì„œ
        1. Authorization Code ê²€ì¦
        2. Discord Access Token êµí™˜
        3. Discord ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
        4. ê¸°ì¡´ ì‚¬ìš©ì ì¡°íšŒ ë˜ëŠ” ìƒì„±
        5. JWT ë°œê¸‰
        """

        def post(self, request):
            # --------------------------------------------------
            # 1. Authorization Code í™•ì¸
            # --------------------------------------------------
            code = request.data.get("code")
            if not code:
                return Response(
                    {"detail": "Authorization code not provided"},
                    status=status.HTTP_400_BAD_REQUEST
                )

            # --------------------------------------------------
            # 2. Access Token êµí™˜
            # --------------------------------------------------
            token_url = "https://discord.com/api/oauth2/token"

            token_data = {
                "client_id": os.environ.get("DISCORD_CLIENT_ID"),
                "client_secret": os.environ.get("DISCORD_CLIENT_SECRET"),
                "grant_type": "authorization_code",
                "code": code,
                "redirect_uri": os.environ.get("DISCORD_REDIRECT_URI_FOR_LOGIN"),
            }

            headers = {
                "Content-Type": "application/x-www-form-urlencoded"
            }

            token_response = requests.post(
                token_url,
                data=token_data,
                headers=headers
            )

            if token_response.status_code != 200:
                return Response(
                    {
                        "detail": "Token exchange failed",
                        "discord_response": token_response.text
                    },
                    status=status.HTTP_400_BAD_REQUEST
                )

            access_token = token_response.json().get("access_token")
            if not access_token:
                return Response(
                    {"detail": "No access token returned"},
                    status=status.HTTP_400_BAD_REQUEST
                )

            # --------------------------------------------------
            # 3. Discord ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
            # --------------------------------------------------
            user_info_response = requests.get(
                "https://discord.com/api/users/@me",
                headers={
                    "Authorization": f"Bearer {access_token}"
                }
            )

            if user_info_response.status_code != 200:
                return Response(
                    {
                        "detail": "Failed to fetch Discord user info",
                        "discord_response": user_info_response.text
                    },
                    status=status.HTTP_400_BAD_REQUEST
                )

            discord_user = user_info_response.json()

            discord_id = discord_user.get("id")
            email = discord_user.get("email")
            username = discord_user.get("username")

            if not email:
                return Response(
                    {"detail": "Email permission not granted"},
                    status=status.HTTP_400_BAD_REQUEST
                )

            # --------------------------------------------------
            # 4. ì‚¬ìš©ì ì¡°íšŒ ë˜ëŠ” ìƒì„±
            # --------------------------------------------------
            try:
                user = User.objects.get(email=email)
                # ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ì â†’ Discord ID ì—°ë™
                user.discord_id = discord_id
                user.save(update_fields=["discord_id"])

            except User.DoesNotExist:
                # ì‹ ê·œ ì‚¬ìš©ì ìƒì„±
                user = User.objects.create(
                    username=username,
                    email=email,
                    discord_id=discord_id
                )
                user.set_unusable_password()
                user.save()

            # --------------------------------------------------
            # 5. JWT ë°œê¸‰
            # --------------------------------------------------
            refresh = RefreshToken.for_user(user)

            return Response(
                {
                    "access": str(refresh.access_token),
                    "refresh": str(refresh),
                    "email": email,
                    "username": username,
                    "discord_id": discord_id,
                },
                status=status.HTTP_200_OK
            )
    ```

### ìì£¼ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜
- `invalid_client`
    - Client ID / Secret ë¶ˆì¼ì¹˜
    - Redirect URI ë¶ˆì¼ì¹˜
- `Method "GET" not allowed`
    - ë¸Œë¼ìš°ì € RedirectëŠ” GET
    - ì‹¤ì œ ì²˜ë¦¬ëŠ” POSTë¡œ ìš”ì²­ í•„ìš”
- `email is null`
    - `email` scope ë¯¸ì„¤ì •

### ë³´ì•ˆ ë° ì£¼ì˜ì‚¬í•­
- Client Secretì€ ì ˆëŒ€ ë…¸ì¶œí•˜ì§€ ì•ŠìŒ
- Redirect URI ë¶ˆì¼ì¹˜ ì‹œ `invalid_client`, `invalid_grant` ì˜¤ë¥˜ì˜ ì£¼ìš” ì›ì¸
- ì´ë©”ì¼ì´ ë°˜í™˜ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ scope ë° ì •ì±… ëª…í™•í™” í•„ìš”
- Authorization CodeëŠ” **1íšŒì„±**ì´ë©° ì¬ì‚¬ìš© ë¶ˆê°€

### ì¶”ê°€ ë‚´ìš©
- Google / GitHub ì†Œì…œ ë¡œê·¸ì¸ê³¼ êµ¬ì¡°ê°€ ê±°ì˜ ë™ì¼
- OAuth ì œê³µìë§Œ ë°”ë€Œê³  ì„œë²„ ë¡œì§ì€ ì¬ì‚¬ìš© ê°€ëŠ¥
- ì†Œì…œ ê³„ì • ë‹¤ì¤‘ ì—°ë™ì„ ê³ ë ¤í•˜ë©´ User-SocialAccount êµ¬ì¡°ë¡œ í™•ì¥ ê°€ëŠ¥