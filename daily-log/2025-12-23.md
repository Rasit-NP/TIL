# 2025-12-23

## ğŸ§  ì˜¤ëŠ˜ ë°°ìš´ ê²ƒ
- ì—¬ëŸ¬ ê¸°ëŠ¥ë“¤ì„ Dockerì— ë‹´ì•„ AWSì— ë°°í¬

### Dokerë¥¼ ì´ìš©í•œ ì»¨í…Œì´ë„ˆí™”
- ë°°í¬ì˜ í•µì‹¬ì€ **í™˜ê²½ì˜ ë™ì¼ì„±**
- `Dockerfile`ê³¼ `docker-compose.yml`ì„ ì‘ì„±í•´ ê°™ì€ í™˜ê²½ì„ êµ¬ì„±
- `Dockerfile`
    ```Docker
    FROM python:3.10-slim
    
    WORKDIR /app

    # ì¢…ì†ì„± ì„¤ì¹˜
    COPY requirements.txt .
    RUN pip install --no-cache-dir -r requirements.txt

    # ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
    COPY . .

    # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ë° Gunicorn ì‹¤í–‰ì€ Composeì—ì„œ ì œì–´í•˜ê±°ë‚˜ ì—¬ê¸°ì„œ ì„¤ì •
    CMD ["gunicorn", "myproject.wsgi:application", "--bind", "0.0.0.0:8000"]
    ```
- `docker-compose.yml`
    ```yml
    services:
    # 1. PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ ì¶”ê°€
    db:
        image: postgres:15-alpine
        restart: always
        env_file: .env
        volumes:
          - postgres_data:/var/lib/postgresql/data
        environment:
          - POSTGRES_DB=nestudy_db            # ì‚¬ìš©í•  DB ì´ë¦„
          - POSTGRES_USER=nestudy_user        # ì‚¬ìš©ìì´ë¦„
          - POSTGRES_PASSWORD=${DB_PASSWORD}  # ë¹„ë°€ë²ˆí˜¸

    # 2. Redis: ë©”ì‹œì§€ ë¸Œë¡œì»¤ (Djangoì™€ Celery ì‚¬ì´ì˜ ë‹¤ë¦¬)
    redis:
        image: redis:alpine
        expose:
        - "6379"

    # 3. Django Web: ì›¹ ì„œë²„
    web:
        build: .
        # Gunicornìœ¼ë¡œ ì‹¤í–‰ (ìš´ì˜ í™˜ê²½ ê¶Œì¥)
        command: gunicorn core.wsgi:application --bind 0.0.0.0:8000
        # command: python manage.py runserver 0.0.0.0:8000
        volumes:
          - .:/app
          - static_volume:/app/staticfiles
          - media_volume:/app/media
        expose:
          - "8000"
        env_file: .env
        environment:
          - CELERY_BROKER_URL=redis://redis:6379/0
          - CELERY_RESULT_BACKEND=redis://redis:6379/1
        depends_on:
          - db
          - redis
    
    # 4. Nginx ì„œë²„
    nginx:
        image: nginx:latest
        ports:
          - "80:80" # ì™¸ë¶€ 80í¬íŠ¸ë¥¼ Nginxë¡œ ì—°ê²°
        volumes:
          - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
          - static_volume:/app/staticfiles # Djangoê°€ ìƒì„±í•œ ì •ì  íŒŒì¼ ê³µìœ 
        depends_on:
          - web

    # 5. Celery Worker: ì‹¤ì œ ë¹„ë™ê¸° ì‘ì—… ìˆ˜í–‰
    worker:
        build: .
        command: celery -A core worker -l info
        volumes:
          - .:/app
        env_file: .env
        environment:
          - CELERY_BROKER_URL=redis://redis:6379/0
        depends_on:
          - db
          - redis

    # 6. Celery Beat: ìŠ¤ì¼€ì¤„ëŸ¬ (ì£¼ê¸°ì  ì‘ì—… ì˜ˆì•½)
    beat:
        build: .
        command: celery -A core beat -l info
        volumes:
          - .:/app
        env_file: .env
        environment:
          - CELERY_BROKER_URL=redis://redis:6379/0
        depends_on:
          - db
          - redis

    volumes:
    postgres_data:
    static_volume:
    media_volume:
    ```
    - `.dockerignore`(ë¹Œë“œ ìµœì í™”)
        - `venv`, `__pycache__`, `.git` ë“± ë¹Œë“œì— í•„ìš” ì—†ëŠ” íŒŒì¼ì„ ì œì™¸í•˜ì—¬ **ë¹Œë“œ ì†ë„ë¥¼ ë¹„ì•½ì ìœ¼ë¡œ í–¥ìƒì‹œí‚¤ê³  ì´ë¯¸ì§€ ìš©ëŸ‰ì„ ì¤„ì„
    - Docker Troubleshooting
        - `localhost`
            - ì»¨í…Œì´ë„ˆ ì•ˆì—ì„œ `localhost`ëŠ” **ì„œë²„ PCê°€ ì•„ë‹Œ ì»¨í…Œì´ë„ˆ ìê¸° ìì‹ ì„ ì˜ë¯¸í•¨
            - Django ì„¤ì •ì—ì„œ DB í˜¸ìŠ¤íŠ¸ë¥¼ `localhost`ê°€ ì•„ë‹Œ **Docker Composeì— ì •ì˜ëœ ì„œë¹„ìŠ¤ ì´ë¦„(`db`)**ìœ¼ë¡œ ì„¤ì •í•´ì•¼ í•¨
        - DB ë§ˆì´ê·¸ë ˆì´ì…˜ íƒ€ì´ë°
            - ì»¨í…Œì´ë„ˆê°€ ë–´ë‹¤ê³  í•´ì„œ DB ì„œë²„ê°€ ë°”ë¡œ ì¤€ë¹„ë˜ëŠ” ê²ƒì€ ì•„ë‹˜
            - ì»¨í…Œì´ë„ˆ ì‹¤í–‰ í›„ ë³„ë„ë¡œ `docker compose exec web python manage.py migrate` ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ í…Œì´ë¸”ì„ ìƒì„±í•¨
    - ìì£¼ ì‚¬ìš©í•˜ëŠ” Docker ëª…ë ¹ì–´
        - `docker compose up --build -d`
            - ì´ë¯¸ì§€ë¥¼ ìƒˆë¡œ ë¹Œë“œí•˜ê³  ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
        - `docker compose down -v`
            - ì»¨í…Œì´ë„ˆë¥¼ ì¤‘ì§€í•˜ê³  **ë°ì´í„° ë³¼ë¥¨ê¹Œì§€ ì‚­ì œ**(ì´ˆê¸°í™” ì‹œ ìœ ìš©)
        - `docker compose ps`
            - í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
        - `docker compose logs -f [ì„œë¹„ìŠ¤ëª…]`
            - ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸ (ë””ë²„ê¹… ì‹œ í•„ìˆ˜)
        - `docker compose exec [ì„œë¹„ìŠ¤ëª…] [ëª…ë ¹ì–´]`
            - ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ëª…ë ¹ì–´ ì‹¤í–‰

### AWS ë°°í¬ ê³¼ì •(EC2)
1. AWS EC2 ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° í™˜ê²½ ì„¤ì •
    - ì¸ìŠ¤í„´ìŠ¤ ì‹œì‘
        - OS ì„ íƒ
            - `Ubuntu Server 22.04 LTS` ë˜ëŠ” `24.04 LTS`ë¥¼ ê¶Œì¥
            - íŒ¨í‚¤ì§€ ê´€ë¦¬ê°€ ìš©ì´
        - ì¸ìŠ¤í„´ìŠ¤ ìœ í˜•
            - Celery Workerì™€ Redisê°€ ë™ì‹œì— ëŒì•„ê°€ì•¼ í•˜ë©´, ìµœì†Œ `t3.medium` ì´ìƒì„ ê¶Œì¥
        - í‚¤ í˜ì–´(Key Pair)
            - `.pem` íŒŒì¼ì„ ì•ˆì „í•œ ê³³ì— ì €ì¥
    - ë³´ì•ˆ ê·¸ë£¹(Security Group) ì„¤ì •
        - ì¸ë°”ìš´ë“œ ê·œì¹™ì— ë‹¤ìŒ í¬íŠ¸ë“¤ì„ ì—´ì–´ì¤˜ì•¼ í•¨
            - 22(SSH)
                - ì„œë²„ ì ‘ì†ìš©
            - 80(HTTP)
                - ì¼ë°˜ ì›¹ ì ‘ì†ìš©
            - 443(HTTPS)
                - ë³´ì•ˆ ì›¹ ì ‘ì†ìš© (SSL ì ìš© ì‹œ)
            - 8000(Custom TCP)
                - (ì„ íƒ) ì´ˆê¸° í…ŒìŠ¤íŠ¸ìš© Django í¬íŠ¸
2. ì„œë²„ ì´ˆê¸° ì„¤ì • ë° Docker ì„¤ì¹˜
    ```Bash
    # ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
    sudo apt-get update && sudo apt-get upgrade -y

    # Docker ì„¤ì¹˜
    curl -fsSl https://get.docker.com -o get-docker.sh
    sudo sh get-docker.sh

    # í˜„ì¬ ì‚¬ìš©ìë¥¼ docker ê·¸ë£¹ì— ì¶”ê°€
    sudo usermod -aG docker $USER

    # Docker Compose ì„¤ì¹˜
    sudo apt-get install docker-compose-plugin -y
    ```
    - EC2ì— ì ‘ì†í•œ í›„(`ssh -i "your-key.pem" ubuntu@your-ec2-ip`), ê°€ì¥ ë¨¼ì € Docker í™˜ê²½ì„ êµ¬ì¶•
3. í”„ë¡œì íŠ¸ ë°°í¬ ë° ì‹¤í–‰
    - ì†ŒìŠ¤ ì½”ë“œ ê°€ì ¸ì˜¤ê¸° ë° í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        ```Bash
        git clone https://github.com/your-repo/your-project.git
        cd your-project

        # í™˜ê²½ ë³€ìˆ˜ ì‘ì„±
        vim .env
        ```
        - GitHub ë“±ì˜ ì €ì¥ì†Œì—ì„œ ì½”ë“œë¥¼ í´ë¡ í•˜ê³ , ë³´ì•ˆìƒ ì œì™¸í–ˆë˜ `.env` íŒŒì¼ì„ ìƒì„±
    - ì„œë¹„ìŠ¤ ì‹¤í–‰
        ```Bash
        # ì´ë¯¸ì§€ ë¹Œë“œ ë° ì»¨í…Œì´ë„ˆ ì‹¤í–‰
        docker compose up --build -d

        # ì‹¤í–‰ ìƒíƒœ í™•ì¸
        docker compose ps

        # ë¡œê·¸ í™•ì¸
        docker compose logs -f web
        docker compose logs -f worker
        ```
4. ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ë™(ìƒì‚°ì„± ë° ì•ˆì •ì„±)
    - EC2 í•œ ëŒ€ì— ëª¨ë“  ê¸°ëŠ¥ì„ ë„ìš°ëŠ” ê²ƒë³´ë‹¤, ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œëŠ” **AWS ê´€ë¦¬í˜• ì„œë¹„ìŠ¤**ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì„±ëŠ¥ê³¼ ë°ì´í„° ë³´ì¡´ ì¸¡ë©´ì—ì„œ ìœ ë¦¬
    - **AWS RDS (Database)**
        - EC2 ë‚´ë¶€ì˜ DB ì»¨í…Œì´ë„ˆ ëŒ€ì‹  RDSë¥¼ ì‚¬ìš©í•˜ë©´ ìë™ ë°±ì—…ê³¼ í™•ì¥ì´ ê°€ëŠ¥
    - **AWS ElastiCache (Redis)**
        - ê³ ì„±ëŠ¥ Redis í™˜ê²½ì„ ì œê³µí•˜ë©°, Celery ë¸Œë¡œì»¤ë¡œ í™œìš©í•˜ê¸°ì— ìµœì 
    - **ë³´ì•ˆ ê·¸ë£¹ ì£¼ì˜**
        - RDSì™€ ElastiCacheì˜ ë³´ì•ˆ ê·¸ë£¹ì—ì„œ **EC2ì˜ ë³´ì•ˆ ê·¸ë£¹ ID**ë¡œë¶€í„° ì˜¤ëŠ” ìš”ì²­ì„ í—ˆìš©í•´ì•¼ ì—°ê²°ì´ ê°€ëŠ¥
5. Nginx Reverse Proxy ë° SSL ì ìš©
    - Dockerë¡œ ë„ìš´ Django(Gunicorn)ëŠ” 8000 í¬íŠ¸ì—ì„œ ë™ì‘
    - ì´ë¥¼ 80 í¬íŠ¸ì™€ ì—°ê²°í•˜ê³  HTTPSë¥¼ ì ìš©í•˜ê¸° ìœ„í•´ Nginxë¥¼ ì„¤ì •
    - Nginx ì»¨í…Œì´ë„ˆ ì¶”ê°€
        - `docker-compose.yml`ì— nginx ì„œë¹„ìŠ¤ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜, EC2ì— ì§ì ‘ ì„¤ì¹˜
    - Cerbotì„ í†µí•œ ì ìš©
        ```Bash
        sudo apt install cerbot python3-cerbot-nginx -y
        sudo cerbot --nginx -d your-domain.com
        ```
6. ë°°í¬ ì‹œ í•µì‹¬ ì²´í¬ë¦¬ìŠ¤íŠ¸
    1. **Static/Media íŒŒì¼ ì²˜ë¦¬**
        - `docker-compose` ì‹¤í–‰ ì‹œ `collectstatic`ì´ ìˆ˜í–‰ë˜ë„ë¡ ì„¤ì •
        - í˜¹ì€ **AWS S3**ë¥¼ ì—°ë™í•˜ì—¬ ì •ì  íŒŒì¼ì„ ì²˜ë¦¬í•´ì•¼ í•¨
    2. **Celery Worker** ìƒíƒœ
        - `celery -A my_project status` ëª…ë ¹ì–´ë¡œ ì›Œì»¤ê°€ ë ˆë””ìŠ¤ì— ì œëŒ€ë¡œ ì—°ê²°ë˜ì—ˆëŠ”ì§€ í™•ì¸
    3. **ë©”ëª¨ë¦¬ ìŠ¤ì™‘**
        - `t3.small` ì´í•˜ ì‚¬ì–‘ì„ ì‚¬ìš© ì¤‘ì´ë¼ë©´ ë©”ëª¨ë¦¬ ë¶€ì¡±ìœ¼ë¡œ ì„œë²„ê°€ ë©ˆì¶œ ìˆ˜ ìˆìŒ
        - `Swap File`ì„ ë§Œë“¤ì–´ ê°€ìƒ ë©”ëª¨ë¦¬ë¥¼ í™•ë³´í•´ì•¼ í•¨
    4. **íŒ€ í”„ë¡œì íŠ¸ ì‹œ ì°¸ê³ **
        - ë‹¤ì–‘í•œ API ê¸°ëŠ¥ì´ í¬í•¨ëœ ê²½ìš°, ê° ê¸°ëŠ¥ì´ ë¹„ë™ê¸° ì‘ì—…(Celery)ê³¼ ì—°ë™ë  ë•Œ ë°œìƒí•  ìˆ˜ ìˆëŠ” íƒ€ì„ì•„ì›ƒ ì„¤ì •ì„ Nginxì™€ Gunicornì—ì„œ ë„‰ë„‰íˆ ì¡ì•„ì£¼ëŠ” ê²ƒì´ ì¢‹ìŒ