# 2026-01-16

## 🧠 오늘 배운 것
- jenkins 설치(by docker)와 실행
- 자동 빌드 설정

## Jenkins 설치와 실행
### jenkins container 생성 및 구동
- docker container에 마운트할 볼륨 디렉토리 생성
    - `cd /home/ubuntu && mkdir jenkins-data`
- 외부에서 접속할 포트를 오픈하고 상태를 확인
    - `sudo ufw allow 8080 /tcp`
    - `sudo ufw reload`
    - `sudo ufw status`
- jenkins container를 생성 및 구동
    - 해당 image가 없는 경우 아래 로그와 같이 다운로드가 진행되고, 이미 있는 경우 생성된 container의 ID만 출력
    - `sudo docker run -d -p 8080:8080 -v /home/ubuntu/jenkins-data:/var/jenkins_home --name jenkins jenkins/jenkins:latest`
- 구동 상태를 보기 위해 아래 명령어로 로그를 확인
    - `sudo docker logs jenkins`
    - 로그 중 초기 패스워드를 기록
- 환경 설정 변경을 위해 docker container를 종료하고 상태를 확인
    - `sudo docker stop jenkins`
    - `sudo docker ps -a`

### 환경 설정 변경
- jenkins data 폴더로 이동
    - `cd /home/ubuntu/jenkins-data`
- update center에 필요한 CA 파일을 다운로드
    - `mkdir update-center-rootCAs`
    - `wget https://cdn.jsdelivr.net/gh/lework/jenkins-update-center/rootCA/update-center.crt -O ./update-center-rootCAs/update-center.crt`
- jenkins의 default 설정에서 특정 미러 사이트로 대체하도록 아래 명령어를 실행
    - `hudson.model.UpdateCenter.xml` 파일을 열어 `https://raw.githubusercontent.com/lework/jenkins-update-center/master/updates/tencent/update-center.json`이 URL로 변경되었는지 확인
- jenkins 서비스를 구동
    - `sudo docker restart jenkins`
    - jenkins가 재구동될 때 `hudson.model.UpdateCenter.xml`에 설정된 Update Site 경로로부터 플러그인 목록을 받아와 파일을 업데이트하고, 해당 파일을 참조하여 설치 가능한 플러그인 목록을 보여주고 설치 시 URL을 참조

### 주요 명령어
- jenkins container 구동 명령어
    - `sudo docker start jenkins`
- jenkins container 종료 명령어
    - `sudo docker stop jenkins`
- jenkins container 로그 명령어
    - `sudo docker logs jenkins`
- jenkins container 로그 실시간 확인
    - `sudo docker logs -f jenkins`

### config 보안 설정 확인
> jenkins에는 빌드, 배포를 위해 git, ec2 등의 중요한 인증 정보를 저장하게 되며, 원격으로 서버에 명령을 실행할 수 있는 권한도 갖게 됨. 따라서 jenkins의 보안이 취약하면 개인정보 유출, 해킹, 악성코드 감염 등의 문제가 발생할 수 있으니 보안 설정에 유의해야 함
- jenkins의 설정 파일을 편집기로 열어 아래 항목들의 값이 `true`로 설정되어 있는지 확인
    - `true`가 아닐 경우 반드시 `true`로 수정
    - `vi /home/ubuntu/jenkins-data/config.xml`
    ```
    <useSecurity>true</useSecurity>
    ...
    <securityRealm class="hudson.security.HudsonPrivateSecurityRealm">
        <disableSignup>true</disableSignup>
    ```
- jenkins 웹에서 security 설정이 정상적으로 되어 있는지 확인
    - 위치
        - Jenkins 관리 > Security
    - Security Realm
        - Jenkin's own user database
    - Authorization
        - Logged-in users can do anything
    - Allow anonymous read access 체크 해제
    - 위 설정은 jenkins 접속 시 로그인 강제, 임의 계정 생성 불가 설정으로 반드시 `true` 값을 유지해야 함

### jenkins 초기 설정 진행
- `http://<EC2 도메인>:8080`으로 접속
    - 로그 확인 단계에서 기록한 초기 패스워드를 입력
- Install suggested plugins로 추천 플러그인 설치
- admin 계정 설정
- 외부 접속 URL을 설정
    - Jenkins URL
        - `http://<EC2 도메인>:8080`

## GitLab 자동 빌드 설정
### 노드(Agent) 추가
- 새로운 노드를 추가해 빌드 부하를 분산
- 특정 환경에서 작업을 수행하기 위해 필수적인 과정
1. 노드 관리 메뉴 진입
    - 대시보드에서 **Jenkins 관리(Manage Jenkins)** 클릭
    - **System Configuration** 섹션의 **Nodes(또는 Manage Nodes and Clouds)** 선택
    - **신규 노드(New Node)** 클릭
2. 기본 정보 입력
    - **Node Name** : 노드를 식별할 이름을 입력
    - **Type** : Permanent Agent를 선택하고 Create 클릭
3. 세부 설정
    |항목   |설명   |
    |-------|------|
    |**Description**    |노드에 대한 간단한 설명|
    |**Remote root directory**  |에이전트 파일 및 빌드 작업이 수행될 절대 경로(예: `/home/jenkins`) |
    |**Labels** |이 노드를 그룹화할 키워드  |
    |**Usage**  |**Use this node as much as possible** 또는 특정 작업만 수행하도록 설정 |
    |**Launch method**  |연결 방식을 선택(보통 **Launch agents via SSH** 선택)  |

4. 실행 방법 설정(SSH 기준)
    - **Host**
        - 대상 서버의 IP 주소나 호스트 명
    - **Credentials**
        - 서버에 접속할 계정 정보(ID/PW 또는 SSH Key)
        - **Credentials** 드롭 다운 옆의 **[Add] -> [Jenkins]** 버튼 클릭
            - **Kind**
                - `SSH Username with private key` 선택
            - **ID**
                - Jenkins 내부에서 식별할 이름
            - **Username**
                - EC2의 기본 계정명
                    - Amazon Linux : `ec2-user`
                    - Ubuntu : `ubuntu`
            - **Private Key**
                - `Enter directly`를 체크하고 **[Add]** 클릭
                - EC2를 생성할 때 받았던 `.pem` 파일의 내용을 메모장으로 열어 전체 복사 후 붙여넣기
    - **Host Key Verification Strategy**
        - 처음 설정 시에는 `Non-verifying Verification Strategy`를 선택하면 키 검증 과정을 건너뛸 수 있음
5. 노드 연결 및 확인
    - 설정을 저장하면 노드 목록에 방금 만든 노드가 표시됨
    - 해당 노드 이름을 클릭하고 **Launch agent** 버튼으로 연결을 시작
    - 하단의 **Log** 메뉴를 통해 연결 과정을 실시간으로 확인할 수 있으며, 마지막에 `Agent succesfully connected and online` 메시지가 뜨면 성공

### Built-in node 빌드 실행 차단
- Built-in node에서 빌드 작업을 수행하지 않도록 **실행자(Executors) 수를 0으로 설정**하거나, **이 노드를 최대한 활용하는 설정을 변경**하는 방식을 사용
- Built-in node 빌드 방지 설정 방법
    - Jenkins 관리 > **Nodes**로 이동
    - **Built-in Node**의 설정(Configure) 클릭
    - **Number of executors**를 **0**으로 수정
        - 혹은, **Usage** 항목을 **Only build jobs with label expressions matching this node**로 변경

### GitLab 저장소 연결
- 프로젝트(Job) 생성 또는 구성
    - Jenkins 관리 화면에서 빌드할 프로젝트를 선택하거나 새로 만듦
    - **New Item**을 클릭하여 'Freestyle project' 또는 'Pipeline'을 생성
- 소스 코드 관리 설정
    - 저장소 정보를 입력
    - **소스 코드 관리** 탭에서 **Git**을 선택
    - **Repository URL**
        - GitLab 프로젝트의 HTTPS 또는 SSH 주소를 입력
    - **Credentials**
        - 등록해둔 GitLab 인증 정보를 선택
        - GitLab에서 Personal Access Token 발급
            - Settings -> Access Tokens 클릭
            - Add new token
                - **Token name** : 원하는 이름
                - **Expiration date** : 가급적 길게 설정
                - **Select scopes** : 반드시 `read_repository`와 `api` 체크
        - Jenkins에 인증 정보 등록
            - **Kind** : `Username with password`
            - **Username** : GitLab 로그인 아이디
            - **Password** : Personal Access Token
            - **ID** : 구분용 이름
    - **Branches to build**
        - 빌드할 브랜치(`*/main` 또는 `*/master`)를 확인
- 빌드를 `my_build` 노드에서만 실행하도록 지정
    - Freestyle Project의 경우
        - **General** 탭에서 **Restrict where this project can be run** 항목을 체크
        - **Label Expression** 칸에 노드 생성 시 설정했던 이름인 `my_build`를 입력
            - 입력 시 아래에 `Label my_build is serviced by 1 node`라는 메시지 확인

### 자동 빌드 설정
- Jenkins 설정(빌드 유발 설정)
    - 해당 프로젝트의 **구성(Configure)**으로 들어감
    - **빌드 유발(Build Triggers)** 탭으로 이동
    - **Build when a change is pushed to GitLab. GitLab webhook URL:...** 항목 체크(Jenkins에 `GitLab` 플러그인 필요)
        - 이곳에 표시되는 URL을 기록
    - **고급(Advanced...)** 클릭
    - **Secret token** 항목을 찾아 **Generate** 클릭
    - 생성된 Token 값을 복사
- GitLab 설정
    - **Settings > Webhooks** 클릭
    - **Add new webhook** 클릭 후 다음과 같이 입력
        - **URL** : 위에서 복사한 Jenkins Webhook URL
        - **Secret token** : 위에서 생성한 Token
        - **Trigger** : **Push events**가 체크되어 있는지 확인
        - **SSL verification** : 만약 Jenkins가 HTTPS가 아닌 HTTP 주소라면 `Enable SSL verification`을 **체크 해제**
- 연결 테스트
    - GitLab Webhook 목록에서 방금 만든 항목의 **Test** 드롭다운을 클릭
    - **Push events**를 선택
    - 상단에 `HTTP 200` 혹은 `HTTP 201` 메시지가 뜨면 성공